name: Deploy to Cloudflare Pages
description: Deploys the built site to Cloudflare Pages and configures custom domain with DNS

inputs:
  api-token:
    description: 'Cloudflare API Token'
    required: true
  account-id:
    description: 'Cloudflare Account ID'
    required: true
  project-name:
    description: 'Cloudflare Pages project name'
    required: true
  domain:
    description: 'Custom domain for the site (e.g., learn.factorylevel.dev)'
    required: true
  zone-domain:
    description: 'Root zone domain (e.g., factorylevel.dev)'
    required: true
  github-token:
    description: 'GitHub token for creating deployments'
    required: true

runs:
  using: composite
  steps:
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ inputs.api-token }}
        accountId: ${{ inputs.account-id }}
        projectName: ${{ inputs.project-name }}
        directory: site
        gitHubToken: ${{ inputs.github-token }}
    
    - name: Setup Cloudflare CLI (Wrangler)
      shell: bash
      run: |
        echo "üîß Installing Wrangler CLI..."
        npm install -g wrangler
        wrangler --version
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.api-token }}
    
    - name: Configure Custom Domain
      shell: bash
      run: |
        echo "üåê Adding custom domain ${{ inputs.domain }} to project..."
        wrangler pages project add-custom-domain ${{ inputs.project-name }} \
          --domain ${{ inputs.domain }} || echo "‚ö†Ô∏è  Domain may already be configured"
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.api-token }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.account-id }}
    
    - name: Setup DNS Record
      shell: bash
      run: |
        echo "üìù Creating DNS record for ${{ inputs.domain }}..."
        
        # Extract subdomain from full domain
        SUBDOMAIN=$(echo "${{ inputs.domain }}" | sed "s/\.${{ inputs.zone-domain }}//")
        
        # Create CNAME record
        wrangler dns record create ${{ inputs.zone-domain }} \
          --type CNAME \
          --name "$SUBDOMAIN" \
          --content ${{ inputs.project-name }}.pages.dev \
          --ttl 1 \
          --proxied || echo "‚ö†Ô∏è  DNS record may already exist"
        
        echo "‚úÖ DNS configuration complete"
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.api-token }}

