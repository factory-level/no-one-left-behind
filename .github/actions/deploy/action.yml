name: Deploy to Cloudflare Pages
description: Deploys the built site to Cloudflare Pages and configures custom domain with DNS

inputs:
  api-token:
    description: 'Cloudflare API Token'
    required: true
  account-id:
    description: 'Cloudflare Account ID'
    required: true
  project-name:
    description: 'Cloudflare Pages project name'
    required: true
  domain:
    description: 'Custom domain for the site (e.g., learn.factorylevel.dev)'
    required: true
  zone-domain:
    description: 'Root zone domain (e.g., factorylevel.dev)'
    required: true
  github-token:
    description: 'GitHub token for creating deployments'
    required: true

runs:
  using: composite
  steps:
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ inputs.api-token }}
        accountId: ${{ inputs.account-id }}
        projectName: ${{ inputs.project-name }}
        directory: site
        gitHubToken: ${{ inputs.github-token }}
    
    - name: Configure Custom Domain
      shell: bash
      run: |
        echo "üåê Adding custom domain ${{ inputs.domain }} to project..."
        
        # Add custom domain to Pages project using API
        response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/${{ inputs.account-id }}/pages/projects/${{ inputs.project-name }}/domains" \
          -H "Authorization: Bearer ${{ inputs.api-token }}" \
          -H "Content-Type: application/json" \
          --data "{\"name\":\"${{ inputs.domain }}\"}")
        
        if echo "$response" | grep -q '"success":true'; then
          echo "‚úÖ Custom domain added successfully"
        elif echo "$response" | grep -q "already exists"; then
          echo "‚ö†Ô∏è  Domain already configured"
        else
          echo "‚ö†Ô∏è  Response: $response"
          echo "Note: Domain may already be configured or will be set up during DNS step"
        fi
    
    - name: Setup DNS Record
      shell: bash
      run: |
        echo "üìù Creating DNS record for ${{ inputs.domain }}..."
        
        # Get zone ID for the domain
        ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${{ inputs.zone-domain }}" \
          -H "Authorization: Bearer ${{ inputs.api-token }}" \
          -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -z "$ZONE_ID" ]; then
          echo "‚ùå Could not find zone ID for ${{ inputs.zone-domain }}"
          exit 1
        fi
        
        echo "Found zone ID: $ZONE_ID"
        
        # Extract subdomain from full domain
        SUBDOMAIN=$(echo "${{ inputs.domain }}" | sed "s/\.${{ inputs.zone-domain }}//")
        
        # Create CNAME record using API
        dns_response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
          -H "Authorization: Bearer ${{ inputs.api-token }}" \
          -H "Content-Type: application/json" \
          --data "{\"type\":\"CNAME\",\"name\":\"$SUBDOMAIN\",\"content\":\"${{ inputs.project-name }}.pages.dev\",\"ttl\":1,\"proxied\":true}")
        
        if echo "$dns_response" | grep -q '"success":true'; then
          echo "‚úÖ DNS record created successfully"
        elif echo "$dns_response" | grep -q "already exists"; then
          echo "‚ö†Ô∏è  DNS record already exists"
        else
          echo "‚ö†Ô∏è  Response: $dns_response"
          echo "Note: DNS record may already exist"
        fi
        
        echo "‚úÖ DNS configuration complete"

